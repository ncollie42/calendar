# Backend Specification

Bun server (static files + bundling) + Convex (data) for the 2026 Planning Calendar.

---

## 1. Architecture

### Project Structure

```
calendar/
├── server.ts            # Bun.serve() dev/prod server
├── build.ts             # Production build script
├── package.json         # Dependencies and scripts
├── tsconfig.json        # TypeScript configuration
├── src/                 # React TypeScript source
│   ├── main.tsx         # Entry point with ConvexProvider
│   ├── App.tsx          # Root component
│   ├── components/      # React components
│   ├── hooks/           # Custom hooks
│   ├── lib/             # Utilities (geometry, weeks, constants)
│   └── styles.css       # Global styles
├── public/              # Static files
│   ├── index.html       # HTML entrypoint
│   ├── manifest.json    # PWA manifest
│   └── sw.js            # Service worker
├── convex/
│   ├── schema.ts        # Database schema
│   └── events.ts        # Event CRUD functions
└── dist/                # Production build output
```

### Bun Server (`server.ts`)

Development mode bundles TypeScript/React on the fly. Production mode serves pre-built files from `dist/`.

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/` | GET | Serve `index.html` |
| `/src/main.tsx` | GET | Bundle and serve React app (dev) |
| `/main.js` | GET | Serve bundled JS (prod) |
| `/styles.css` | GET | Serve CSS |
| `/manifest.json` | GET | PWA manifest |
| `/sw.js` | GET | Service worker |
| `/icon-192.png` | GET | PWA icon (192×192, generated) |
| `/icon-512.png` | GET | PWA icon (512×512, generated) |

### Dynamic Icon Generation

PWA icons are generated at runtime using raw PNG construction:
1. PNG signature: `[137, 80, 78, 71, 13, 10, 26, 10]`
2. IHDR chunk: width/height as 32-bit big-endian, bit depth 8, color type 2 (RGB)
3. IDAT chunk: Use `Bun.deflateSync()` to compress raw pixel data
4. Each chunk needs CRC32 checksum of type + data

Alternative: Include static PNG files in `public/` instead of generating at runtime.

### Development Hot Reload

The dev server caches the bundled JS for performance. File watching invalidates the cache:

```typescript
if (!isProd) {
  const watcher = require("fs").watch("./src", { recursive: true }, () => {
    cachedBundle = null;
  });
  process.on("exit", () => watcher.close());
}
```

Note: This is basic cache invalidation, not HMR. Browser refresh required after changes.

---

## 2. Data Model

### Schema

```typescript
// convex/schema.ts
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  events: defineTable({
    title: v.string(),
    week: v.union(v.number(), v.null()),
    priority: v.union(
      v.literal("major"),
      v.literal("big"),
      v.literal("medium"),
      v.literal("minor")
    ),
    description: v.optional(v.string()),
    createdAt: v.number(),
  }),
});
```

---

## 3. Convex Functions

### Queries

| Function | Args | Returns | Purpose |
|----------|------|---------|---------|
| `getEvents` | - | `Event[]` | Get all events |

### Mutations

| Function | Args | Returns | Purpose |
|----------|------|---------|---------|
| `createEvent` | `title, week, priority, description?` | `eventId` | Create event |
| `updateEvent` | `eventId, updates` | - | Update event |
| `deleteEvent` | `eventId` | - | Delete event |

---

## 4. Environment Variables

**Bun server:** `PORT` (default: 3000), `NODE_ENV` (development/production)

**Convex:** Managed via `.env.local` (auto-generated by `bunx convex dev`)
```
CONVEX_DEPLOYMENT=dev:opulent-lynx-809
CONVEX_URL=https://opulent-lynx-809.convex.cloud
```

**Frontend:** Convex URL configured in `src/main.tsx` (must match `CONVEX_URL` from `.env.local`)

---

## 5. Deployment

### Initial Setup

```bash
# 1. Install dependencies
bun install

# 2. Deploy Convex (creates .env.local with deployment URL)
bunx convex deploy

# 3. Update src/main.tsx with your Convex URL from .env.local

# 4. Build production bundle
bun run build

# 5. Deploy (e.g., to Fly.io, Railway, or any Node.js host)
# The server.ts file serves the built files in production mode
```

### Subsequent Deploys

```bash
# Deploy Convex functions (if changed)
bunx convex deploy

# Rebuild and deploy server (if frontend/server changed)
bun run build
# Deploy your preferred way
```

---

## 6. Local Development

```bash
# Terminal 1: Start Convex dev server (uses .env.local)
bunx convex dev

# Terminal 2: Start Bun dev server
bun run dev

# Open http://localhost:3000
```

Note: `bunx convex dev` reads from `.env.local`. The Convex URL in `src/main.tsx` should match `CONVEX_URL` from that file.

---

## 7. Testing

### API Testing (via Convex Dashboard)

1. Go to https://dashboard.convex.dev
2. Select your project
3. Use the "Functions" tab to test queries/mutations

### Local Testing

```bash
# Development mode
bun run dev

# Production mode
bun run build
bun run start

# Verify static files served
curl http://localhost:3000/
curl http://localhost:3000/manifest.json
curl http://localhost:3000/sw.js
curl http://localhost:3000/icon-192.png --output /dev/null -w "%{http_code}\n"
```

---

## 8. Implementation Notes

### TypeScript Quirks

- Convex generated files (`convex/_generated/`) don't exist until first `bunx convex dev`
- Run `bunx convex codegen` to generate types without starting dev server
- Bun's Response body may need `as unknown as BodyInit` cast for Uint8Array

### Priority Type Alignment

The Convex schema uses a string union for priority. When using the value in frontend components that expect a `Priority` type, cast explicitly:

```typescript
const priority = event.priority as Priority;
```

### Convex URL Configuration

Bun auto-loads `.env.local` and exposes variables via `process.env`. Inject the Convex URL at bundle time:

**server.ts** (in `bundleApp` function):
```typescript
const result = await Bun.build({
  entrypoints: ["./src/main.tsx"],
  define: {
    "process.env.CONVEX_URL": JSON.stringify(process.env.CONVEX_URL),
  },
});
```

**src/main.tsx**:
```typescript
const convex = new ConvexReactClient(process.env.CONVEX_URL!);
```

This approach:
- Reads from `.env.local` automatically (no manual copy)
- Works in both dev and production
- Fails fast if CONVEX_URL is missing

### Build Order Dependency

TypeScript compilation depends on Convex generated files:

1. Run `bunx convex codegen` (or `bunx convex dev`) first
2. Then `bunx tsc --noEmit` will succeed
3. `convex/_generated/` is gitignored but required for builds

CI/CD pipelines must run codegen before type checking.

### Future: Authentication

Authentication is deferred to a future phase. When added:
- Add `@convex-dev/auth` tables via `authTables` spread
- Add `createdBy: v.id("users")` to events
- Add `calendars` and `memberships` tables for multi-user support
- Add auth checks to all mutations
