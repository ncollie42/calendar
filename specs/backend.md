# Backend Specification

Go server (static files) + Convex (data) for the 2026 Planning Calendar.

---

## 1. Architecture

### Project Structure

```
calendar/
├── main.go              # Static file server (Fly.io)
├── index.html           # Frontend (embedded in Go binary)
├── manifest.json        # PWA manifest (embedded)
├── sw.js                # Service worker (embedded)
├── package.json         # Convex dependency
├── convex/
│   ├── functions.js     # Convex queries and mutations
│   └── schema.ts        # Convex schema definition
```

### Go Server (`main.go`)

Single binary with embedded static files. **No Redis dependency.**
Deployed on Fly.io.

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/` | GET | Serve `index.html` |
| `/manifest.json` | GET | PWA manifest |
| `/sw.js` | GET | Service worker |
| `/icon-192.png` | GET | PWA icon (192×192, generated) |
| `/icon-512.png` | GET | PWA icon (512×512, generated) |

### Convex Functions

Data is stored in Convex, accessed directly from frontend.

| Function | Type | Purpose |
|----------|------|---------|
| `getState` | Query | Return `{"events2026": [...]}` |
| `setState` | Mutation | Save full state |

### Data Model

```typescript
// convex/schema.ts
{
  state: {
    events2026: Array<{
      id: string,           // "evt_1704067200000"
      title: string,
      week: number | null,  // null = backlog
      priority: string,     // major|big|medium|minor
      description?: string
    }>
  }
}
```

### Environment Variables

**Go server:** Only `PORT` (no Redis needed)

**Convex:** Managed via `.env.local` (auto-generated by `npx convex dev`)
```
CONVEX_DEPLOYMENT=dev:opulent-lynx-809
CONVEX_URL=https://opulent-lynx-809.convex.cloud
```

**Frontend:** Convex URL hardcoded in `index.html` (must match `CONVEX_URL` from `.env.local`)

---

## 2. Deployment

### Initial Setup

```bash
# 1. Install dependencies
bun install

# 2. Deploy Convex (creates .env.local with deployment URL)
bunx convex deploy

# 3. Update index.html with your Convex URL from .env.local
# The CONVEX_URL must match the hardcoded URL in index.html

# 4. Deploy Go server to Fly.io
fly deploy
```

### Subsequent Deploys

```bash
# Deploy Convex functions (if changed)
bunx convex deploy

# Deploy Go server (if index.html or main.go changed)
fly deploy
```

---

## 3. Local Development

```bash
# Terminal 1: Start Convex dev server (uses .env.local)
bunx convex dev

# Terminal 2: Start Go server
go run main.go

# Open http://localhost:8080
```

Note: `bunx convex dev` reads from `.env.local`. The Convex URL in `index.html` should match `CONVEX_URL` from that file.

---

## 4. Testing

### API Testing (via Convex Dashboard)

1. Go to https://dashboard.convex.dev
2. Select your project
3. Use the "Functions" tab to test queries/mutations

### Local Testing

```bash
# Build and run Go server
go build && ./calendar

# Verify static files served
curl http://localhost:8080/
curl http://localhost:8080/manifest.json
curl http://localhost:8080/sw.js
curl http://localhost:8080/icon-192.png --output /dev/null -w "%{http_code}\n"
```
